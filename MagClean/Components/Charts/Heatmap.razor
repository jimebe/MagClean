@using System.Globalization
@using Plotly.Blazor.LayoutLib
@using Plotly.Blazor.LayoutLib.XAxisLib
@using Font = Plotly.Blazor.LayoutLib.AnnotationLib.Font

@if (Loading)
{
    <div>Loading...</div>
}
else if (Loaded)
{
    <PlotlyChart style="min-height: 80vh; min-height: 600px" Layout="layout" Config="config" Data="data" Id="HeatMapChart" @ref="plotlyChart" />
}
else
{
    <button type="button" class="btn btn-secondary" @onclick="LoadHeatmap">Load</button>
}

@code {
    PlotlyChart plotlyChart;
    Layout layout;
    Config config;
    IList<ITrace> data;
    bool Loaded;
    bool Loading;

    [Parameter]
    public MagFile File { get; set; }

    public async Task LoadHeatmap()
    {
        Loading = true;
        StateHasChanged();
        layout = new Layout
        {
            Title = new Plotly.Blazor.LayoutLib.Title
            {
                Text = ""
            },
            Annotations = new List<Annotation>(),
            XAxis = new List<XAxis>
    {
    new ()
    {
    Ticks = TicksEnum.Empty,
    Side = SideEnum.Top
    }
    },
            YAxis = new List<YAxis>
    {
    new ()
    {
    Ticks = Plotly.Blazor.LayoutLib.YAxisLib.TicksEnum.Empty,
    TickSuffix = " ",
    }
    }
        };

        config = new Config
        {
            ShowLink = false,
            Responsive = true,
            DisplayLogo = false
        };
        data = GetMapData();

        //AddAnnotations(layout, data.First());
        Loading = false;
        Loaded = true;
    }

    IList<ITrace> GetMapData()
    {
        IList<ITrace> mapData = new List<ITrace>();
        if (File != null)
        {
            var dataLines = File.Lines.Where(x => !x.Metadata);
            var xMin = dataLines.Min(x => x.EastingRounded);
            var xMax = dataLines.Max(x => x.EastingRounded);
            var yMin = dataLines.Min(x => x.NorthingRounded);
            var yMax = dataLines.Max(x => x.NorthingRounded);

            var xRange = Enumerable.Range(xMin, xMax - xMin).OrderBy(x => x).ToArray();
            var yRange = Enumerable.Range(yMin, yMax - yMin).OrderBy(x => x).ToArray();
            var t1 = yRange.Count();
            var zValues = new int?[yRange.Count()][];
            var highestCount = 0;
            var valueLookup = File.Lines.GroupBy(x => x.EastingNorthingRounded).ToDictionary(y => y.Key, y => y.Count());
            for (int y = 0; y < yRange.Count(); y++)
            {
                var values = new int?[xRange.Count()];
                var yValue = yRange[y];
                for (int x = 0; x < xRange.Count(); x++)
                {
                    var xValue = xRange[x];
                    var keyValue = xValue + " - " + yValue;
                    int? count = valueLookup.ContainsKey(keyValue) ? valueLookup[keyValue] : null;
                    if (count.HasValue && count.Value > highestCount)
                    {
                        highestCount = count.Value;
                    }

                    //var textColor = count != 0 ? "white" : "black";

                    //var annotation = new Annotation
                    //{
                    //    XRef = "x1",
                    //    YRef = "y1",
                    //    X = xValue,
                    //    Y = yValue,
                    //    Text = count > 0 ? count.ToString() : string.Empty,
                    //    Font = new Font
                    //    {
                    //        Family = "Arial",
                    //        Size = 12,
                    //        Color = textColor
                    //    },
                    //    ShowArrow = false,
                    //};
                    //layout.Annotations.Add(annotation);
                }
                zValues[y] = values;
            }

            var colorRange = Enumerable.Range(0, highestCount);
            var colorScale = new string[colorRange.Count()][];
            for (int cs = 0; cs < colorScale.Count(); cs++)
            {
                var hexColor = cs switch
                {
                    >= 5 => "#E74C3C",
                    < 5 and >= 2 => "#F7DC6F",
                    1 => "#EAECEE",
                    _ => "#FDFEFE"
                };
                var color = new[] { cs.ToString(), hexColor };
                colorScale[cs] = color;
            }

            mapData.Add(new HeatMap()
            {
                X = xRange.Cast<object>().ToList(),
                Y = yRange.Cast<object>().ToList(),
                Z = zValues.Cast<object>().ToList(),
                ColorScale = colorScale,
                ShowScale = false
            });
        }

        return mapData;
    }

    static void AddAnnotations(Layout layout, ITrace trace)
    {
        if (trace is not HeatMap { Z: List<object> zValues } heatMap) return;

        for (var i = 0; i < heatMap.Y.Count; i++)
        {
            for (var j = 0; j < heatMap.X.Count; j++)
            {
                var currentValue = ((int?[])zValues[i])[j];
                var textColor = currentValue != 0.0 ? "white" : "black";

                var result = new Annotation
                {
                    XRef = "x1",
                    YRef = "y1",
                    X = heatMap.X[j],
                    Y = heatMap.Y[i],
                    Text = currentValue.HasValue ? currentValue.Value.ToString(CultureInfo.InvariantCulture) : string.Empty,
                    Font = new Font
                    {
                        Family = "Arial",
                        Size = 12,
                        Color = textColor
                    },
                    ShowArrow = false,
                };
                layout.Annotations.Add(result);
            }
        }
    }
}